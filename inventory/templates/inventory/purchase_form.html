{% extends "cores/base1.html" %}
{% block title %}New Purchase{% endblock %}

{% block content %}
<div class="container">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">New Purchase</h4>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <!-- Supplier -->
        <div class="mb-3">
          <label for="supplier" class="form-label">Supplier</label>
          <select name="supplier" id="supplier" class="form-select" required>
            <option value="">Select Supplier</option>
            {% for supplier in suppliers %}
              <option value="{{ supplier.id }}">{{ supplier.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Restaurant -->
        <input type="hidden" name="restaurant" value="{{ request.user.restaurant.id }}">

        <!-- Notes -->
        <div class="mb-3">
          <label for="notes" class="form-label">Notes</label>
          <textarea name="notes" id="notes" class="form-control"></textarea>
        </div>

        <hr>
        <h5>Purchase Items</h5>

        <table class="table table-bordered" id="purchase-items-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Unit Cost</th>
              <th>Line Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <select name="item[]" class="form-select item-select" required>
                  <option value="">Select Item</option>
                  {% for item in stock_items %}
                    <option value="{{ item.id }}">{{ item.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input type="number" name="quantity[]" class="form-control quantity" step="0.01" value="0" required></td>
              <td><input type="number" name="unit_cost[]" class="form-control unit_cost" step="0.01" value="0" required></td>
              <td><input type="number" name="line_total[]" class="form-control line_total" step="0.01" value="0" readonly></td>
              <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
            </tr>
          </tbody>
        </table>

        <button type="button" id="add-row" class="btn btn-primary btn-sm mb-3">Add Item</button>

        <div class="mb-3">
          <label class="form-label">Total Cost:</label>
          <input type="number" name="total_cost" id="total_cost" class="form-control" value="0" readonly>
        </div>

        <button type="submit" class="btn btn-success">Create Purchase</button>
        <a href="{% url 'inventory:purchases' %}" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function updateLineTotal(row) {
    const qty = parseFloat(row.querySelector('.quantity').value) || 0;
    const cost = parseFloat(row.querySelector('.unit_cost').value) || 0;
    row.querySelector('.line_total').value = (qty * cost).toFixed(2);
    updateTotalCost();
  }

  function updateTotalCost() {
    let total = 0;
    document.querySelectorAll('.line_total').forEach(input => {
      total += parseFloat(input.value) || 0;
    });
    document.getElementById('total_cost').value = total.toFixed(2);
  }

  document.querySelectorAll('.quantity, .unit_cost').forEach(input => {
    input.addEventListener('input', function() {
      updateLineTotal(this.closest('tr'));
    });
  });

  document.getElementById('add-row').addEventListener('click', function() {
    const table = document.getElementById('purchase-items-table').querySelector('tbody');
    const newRow = table.rows[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(i => i.value = 0);
    newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    table.appendChild(newRow);
    newRow.querySelectorAll('.quantity, .unit_cost').forEach(input => {
      input.addEventListener('input', function() {
        updateLineTotal(this.closest('tr'));
      });
    });
    newRow.querySelector('.remove-row').addEventListener('click', function() {
      this.closest('tr').remove();
      updateTotalCost();
    });
  });

  document.querySelectorAll('.remove-row').forEach(btn => {
    btn.addEventListener('click', function() {
      this.closest('tr').remove();
      updateTotalCost();
    });
  });
});
</script>
{% endblock %}
